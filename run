#!/bin/bash

# MathPix LaTeX Extractor - Setup and Run Script
# This script automatically sets up the environment and runs the application

set -e  # Exit on any error

echo "ğŸš€ MathPix LaTeX Extractor Setup & Run Script"
echo "=============================================="

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

echo "ğŸ“ Working directory: $SCRIPT_DIR"

# Check if Python 3 is available
if ! command -v python3 &> /dev/null; then
    echo "âŒ Error: Python 3 is not installed or not in PATH"
    echo "   Please install Python 3 and try again"
    exit 1
fi

echo "âœ… Python 3 found: $(python3 --version)"

# Create virtual environment if it doesn't exist
if [ ! -d ".venv" ]; then
    echo "ğŸ“¦ Creating virtual environment..."
    python3 -m venv .venv
    echo "âœ… Virtual environment created"
else
    echo "âœ… Virtual environment already exists"
fi

# Activate virtual environment
echo "ğŸ”§ Activating virtual environment..."
source .venv/bin/activate

# Upgrade pip
echo "ğŸ“ˆ Upgrading pip..."
pip install --upgrade pip

# Install dependencies
echo "ğŸ“š Installing dependencies..."
if [ -f "requirements.txt" ]; then
    pip install -r requirements.txt
else
    echo "ğŸ“ Installing core dependencies..."
    pip install flask requests python-dotenv
fi

echo "âœ… Dependencies installed"

# Check if .env file exists
if [ ! -f ".env" ]; then
    echo "âš ï¸  Warning: .env file not found!"
    echo "   Creating .env from template..."
    
    if [ -f ".env.example" ]; then
        cp .env.example .env
        echo "ğŸ“ Created .env file from template"
        echo "âš ï¸  IMPORTANT: Please edit .env and add your MathPix API credentials:"
        echo "   - MATHPIX_APP_ID=your_app_id_here"
        echo "   - MATHPIX_APP_KEY=your_app_key_here"
        echo ""
        echo "Press Enter to continue after editing .env, or Ctrl+C to exit..."
        read -r
    else
        echo "âŒ Error: No .env.example file found"
        echo "   Please create a .env file with your MathPix API credentials"
        exit 1
    fi
else
    echo "âœ… .env file found"
fi

# Verify environment variables
echo "ğŸ” Checking environment variables..."
python3 -c "
import os
from dotenv import load_dotenv
load_dotenv()

app_id = os.getenv('MATHPIX_APP_ID')
app_key = os.getenv('MATHPIX_APP_KEY')

if not app_id or not app_key:
    print('âŒ Error: Missing API credentials in .env file')
    print('   Please check your MATHPIX_APP_ID and MATHPIX_APP_KEY')
    exit(1)

print(f'âœ… API credentials found (ID: {app_id[:10]}...)')
"

if [ $? -ne 0 ]; then
    echo "âŒ Environment variable check failed"
    exit 1
fi

# Check if app.py exists
if [ ! -f "app.py" ]; then
    echo "âŒ Error: app.py not found"
    echo "   Make sure you're running this script from the project directory"
    exit 1
fi

echo "âœ… Application file found"

# Set permissions for security
if [ -f ".env" ]; then
    chmod 600 .env
    echo "ğŸ”’ Secured .env file permissions"
fi

echo ""
echo "ğŸ‰ Setup complete! Starting the application..."
echo "ğŸ“± The app will be available at: http://127.0.0.1:5000"
echo "ğŸ›‘ Press Ctrl+C to stop the server"
echo ""

# Run the application
python3 app.py
